
FROM debian:bullseye

LABEL maintainer="tony.fischetti@gmail.com"

ENV TERM=screen-256color
ENV LANG=C.UTF-8
ENV SHELL=/usr/bin/zsh

ARG USERNAME=marvin
ARG USER_UID=1000
ARG USER_GID=$USER_UID


# essential packages
RUN apt-get update -qq                                                  && \
    apt-get install -qq -y --no-install-recommends apt-utils            && \
    apt-get install -qq -y --no-install-recommends                      \
      r-base r-base-dev git nodejs npm vim zsh wget curl gnupg          \
      vim ack autotools-dev sbcl libsystemd0 libsystemd-dev ssh         \
      libcurses-perl build-essential tmux sudo htop cpanminus           \
      xz-utils automake autoconf ca-certificates libevent-dev           \
      debianutils diffutils moreutils ffmpeg figlet ncdu libxml2        \
      libncurses-dev libtool ncdu openssl python3-pip racket zip        \
      suckless-tools sqlite3 par pandoc pwgen ccze parallel pigz        \
      neofetch iotop imv renameutils apt-transport-https fd-find        \
      libnotify-dev colordiff dos2unix gawk jpegoptim keyutils          \
      patchutils bison libcurl4-openssl-dev libxml2-dev ecl             \
      apt-xapian-index libssl-dev rsync acpi visidata                   && \
    apt-get clean                                                       && \
    cpanm install Term::Animation

# create non-root user
RUN groupadd --gid $USER_GID $USERNAME                                  && \
    useradd --uid $USER_UID --gid $USER_GID -m $USERNAME                && \
    usermod -a $USERNAME -G sudo                                        && \
    echo $USERNAME ALL=\(root\) NOPASSWD:ALL > /etc/sudoers.d/$USERNAME && \
    chmod 0440 /etc/sudoers.d/$USERNAME                                 && \
    chsh $USERNAME -s /usr/bin/zsh

USER $USERNAME
WORKDIR /home/$USERNAME

# gpg fix
RUN mkdir -p ~/.gnupg/tmp                                               && \
    chown -R $(whoami) ~/.gnupg/                                        && \
    chmod 600 ~/.gnupg/*                                                && \
    chmod 700 ~/.gnupg

# setup nodejs
RUN curl -fsSL https://deb.nodesource.com/setup_16.x | sudo -E bash -  && \
    sudo apt update                                                    && \
    sudo apt install -y nodejs                                         && \
    sudo apt remove cmdtest                                            && \
    curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg |                \
          sudo apt-key add -                                           && \
    echo "deb https://dl.yarnpkg.com/debian/ stable main" | \
          sudo tee /etc/apt/sources.list.d/yarn.list                   && \
    sudo apt-get update                                                && \
    sudo apt-get install yarn -y

# setup R
RUN git clone https://github.com/tonyfischetti/rix.git ~/.rix/          && \
    cd ~/.rix                                                           && \
    R_LIBS=~/local/R_libs/ ./install.sh

# setup zsh
RUN git clone https://github.com/tonyfischetti/zix.git ~/.zsh           && \
    cd ~/.zsh                                                           && \
    ./install.sh                                                        && \
    sudo ln -s /usr/bin/zsh /usr/local/bin/zsh                          && \
    sudo chsh -s /usr/bin/zsh $USERNAME

# setup lisp
RUN git clone https://github.com/tonyfischetti/clix.git ~/.lisp         && \
    cd ~/.lisp                                                          && \
    ./install.sh                                                        && \
    sudo ln -s /usr/bin/sbcl /usr/local/bin/sbcl

# setup tmux
RUN git clone https://github.com/tonyfischetti/tmux                     && \
    cd tmux                                                             && \
    git checkout tony-changes                                           && \
    ./autogen.sh                                                        && \
    ./configure                                                         && \
    make                                                                && \
    sudo make install                                                   && \
    cd ../                                                              && \
    rm -rf tmux                                                         && \
    git clone https://github.com/tonyfischetti/tmix.git ~/.tmux         && \
    ln -s ~/.tmux/.tmux.conf ~/.tmux.conf

# setup zpaq
RUN git clone https://github.com/tonyfischetti/zpaq                     && \
    cd zpaq                                                             && \
    make                                                                && \
    sudo make install                                                   && \
    cd ..                                                               && \
    rm -rf zpaq


# setup vim
RUN wget "https://github.com/neovim/neovim/releases/download/v0.8.1/nvim-linux64.deb" -O nvim.deb && \
    sudo apt install ./nvim.deb                                         && \
    sudo apt install -qq -y --no-install-recommends                     \
      python3-pynvim python3-greenlet python3-msgpack lua-luv           \
      libtermkey1 libvterm0 python3-neovim libluajit-5.1-2              \
      libmsgpackc2                                                      && \
    mkdir -p ~/.config                                                  && \
    git clone https://github.com/tonyfischetti/vix.git ~/.config/nvim   && \
    cd ~/.config/nvim                                                   && \
    ./install.sh 2>&1                                                   && \
    cd ~                                                                && \
    rm nvim.deb

# setup powershell
RUN wget "https://github.com/PowerShell/PowerShell/releases/download/v7.3.0/powershell_7.3.0-1.deb_amd64.deb" -O powershell.deb && \
    sudo apt install ./powershell.deb                                   && \
    rm powershell.deb

# clean up
RUN sudo apt autoremove -y

